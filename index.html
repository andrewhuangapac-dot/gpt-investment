<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase å®æ—¶æ—¥å¿—ç›‘æ§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Courier New', Courier, monospace; }
        .log-item { border-left: 4px solid #3b82f6; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="app" class="max-w-3xl mx-auto p-6">
    <header class="mb-6 flex justify-between items-center border-b border-gray-700 pb-4">
        <h1 class="text-2xl font-bold text-blue-400">ğŸ“¡ ç³»ç»Ÿæ—¥å¿—ç›‘æ§ç»ˆç«¯</h1>
        <span class="px-3 py-1 rounded text-sm font-bold" 
              :class="statusClass">
            {{ connectionStatus }}
        </span>
    </header>

    <div class="bg-gray-800 p-4 rounded mb-6 border border-gray-700">
        <h3 class="text-sm text-gray-400 mb-2">ğŸ›  æ‰‹åŠ¨æµ‹è¯•é€šé“</h3>
        <div class="flex gap-2">
            <input type="text" v-model="testMessage" @keyup.enter="sendTestLog"
                   placeholder="è¾“å…¥æµ‹è¯•å†…å®¹ï¼ŒæŒ‰å›è½¦å‘é€..."
                   class="flex-1 bg-gray-900 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-blue-500 text-white">
            <button @click="sendTestLog" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition">
                å‘é€ä¿¡å·
            </button>
        </div>
    </div>

    <div class="space-y-3">
        <div v-if="logs.length === 0" class="text-gray-500 text-center py-10 italic">
            Waiting for signals... (æš‚æ— æ•°æ®)
        </div>

        <div v-for="(log, index) in logs" :key="index" class="log-item bg-gray-800 p-3 rounded shadow hover:bg-gray-750 transition">
            <div class="flex justify-between items-start">
                <span class="text-green-400 font-bold mr-2">></span>
                <span class="flex-1 break-all">{{ log.content }}</span>
                <span class="text-xs text-gray-500 ml-2 whitespace-nowrap">{{ log.time }}</span>
            </div>
        </div>
    </div>
</div>

<script>
    // âš ï¸âš ï¸âš ï¸ è¯·åœ¨æ­¤å¤„ç²˜è´´ä½ çš„é…ç½® âš ï¸âš ï¸âš ï¸
    const firebaseConfig = {
    Â  apiKey: "AIzaSyACJJPHaq3VCpnh1SyCehiwTiQf3IEiY78",
Â      authDomain: "stock-app-1f470.firebaseapp.com",
Â      databaseURL: "https://stock-app-1f470-default-rtdb.asia-southeast1.firebasedatabase.app",
Â      projectId: "stock-app-1f470",
Â      storageBucket: "stock-app-1f470.firebasestorage.app",
Â      messagingSenderId: "474136651144",
Â      appId: "1:474136651144:web:4ff02c92036c4b4ca8063d"
    };

    new Vue({
        el: '#app',
        data: {
            logs: [],
            connectionStatus: 'ç³»ç»Ÿåˆå§‹åŒ–...',
            statusType: 'loading', // loading, success, error
            testMessage: ''
        },
        computed: {
            statusClass() {
                if (this.statusType === 'success') return 'bg-green-900 text-green-300';
                if (this.statusType === 'error') return 'bg-red-900 text-red-300';
                return 'bg-yellow-900 text-yellow-300';
            }
        },
        mounted() {
            this.initFirebase();
        },
        methods: {
            initFirebase() {
                try {
                    // 1. åˆå§‹åŒ–
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    
                    // 2. æ›´æ–°çŠ¶æ€ï¼šè¯æ˜ä»£ç è·‘é€šäº†
                    this.connectionStatus = 'ğŸŸ¢ å·²è¿æ¥æ•°æ®åº“ï¼Œæ­£åœ¨ç›‘å¬...';
                    this.statusType = 'success';

                    // 3. å¼€å§‹ç›‘å¬ 'logs' èŠ‚ç‚¹
                    const dbRef = firebase.database().ref('logs');
                    
                    // ä½¿ç”¨ child_addedï¼Œæ¯æ¬¡æœ‰æ–°æ•°æ®ï¼ˆæˆ–åˆæ¬¡åŠ è½½æ—§æ•°æ®ï¼‰éƒ½ä¼šè§¦å‘ä¸€æ¬¡
                    dbRef.on('child_added', (snapshot) => {
                        const rawVal = snapshot.val();
                        console.log("æ”¶åˆ°æ•°æ®:", rawVal); // åœ¨æ§åˆ¶å°æ‰“å°ï¼Œæ–¹ä¾¿è°ƒè¯•

                        // å¤„ç†æ•°æ®æ ¼å¼ï¼šå¦‚æœæ˜¯å¯¹è±¡å°±å– textï¼Œå¦‚æœæ˜¯çº¯å­—ç¬¦ä¸²å°±ç›´æ¥ç”¨
                        let displayContent = '';
                        let displayTime = new Date().toLocaleTimeString();

                        if (typeof rawVal === 'object' && rawVal !== null) {
                            displayContent = rawVal.text || JSON.stringify(rawVal);
                            if(rawVal.timestamp) displayTime = new Date(rawVal.timestamp).toLocaleTimeString();
                        } else {
                            displayContent = String(rawVal);
                        }

                        // å°†æ–°æ•°æ®æ¨å…¥æ•°ç»„å¤´éƒ¨ (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼Œå¦‚æœæƒ³åœ¨ä¸‹é¢å°±æŠŠ unshift æ”¹æˆ push)
                        this.logs.unshift({
                            content: displayContent,
                            time: displayTime
                        });
                    }, (error) => {
                        // ç›‘å¬è¿‡ç¨‹æŠ¥é”™ï¼ˆé€šå¸¸æ˜¯æƒé™ä¸è¶³ï¼‰
                        console.error(error);
                        this.connectionStatus = 'âŒ æƒé™/è¯»å–é”™è¯¯: ' + error.message;
                        this.statusType = 'error';
                    });

                } catch (e) {
                    console.error(e);
                    this.connectionStatus = 'âŒ é…ç½®é”™è¯¯: ' + e.message;
                    this.statusType = 'error';
                }
            },
            
            // å‘é€æµ‹è¯•æ•°æ®çš„åŠŸèƒ½
            sendTestLog() {
                if (!this.testMessage.trim()) return;

                const dbRef = firebase.database().ref('logs');
                const newLog = {
                    text: this.testMessage,
                    timestamp: firebase.database.ServerValue.TIMESTAMP // è®©æœåŠ¡å™¨æ‰“æ—¶é—´æˆ³
                };

                // æ¨é€æ•°æ®
                dbRef.push(newLog)
                    .then(() => {
                        console.log("å‘é€æˆåŠŸ");
                        this.testMessage = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                    })
                    .catch(error => {
                        alert("å‘é€å¤±è´¥: " + error.message);
                    });
            }
        }
    });
</script>
</body>
</html>
