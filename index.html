<div id="ai-portfolio-widget" style="font-family: -apple-system, sans-serif; border-radius: 24px; overflow: hidden; max-width: 380px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); background: white; margin: 0 auto; border: 1px solid #e2e8f0;">
    
    <div style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <div style="font-weight: 900; font-size: 18px;">ç¾è‚¡ AI æŠ•è³‡å»ºè­°</div>
            <div id="widget-status" style="font-size: 11px; color: #94a3b8; margin-top:2px;">Connecting...</div>
        </div>
        <div style="display: flex; align-items: center; gap: 6px; background: rgba(34, 197, 94, 0.1); padding: 4px 8px; border-radius: 8px;">
            <div class="live-dot" style="width: 6px; height: 6px; background: #22c55e; border-radius: 50%;"></div>
            <span style="font-size: 10px; color: #4ade80; font-weight: 900;">LIVE</span>
        </div>
    </div>

    <div id="skeleton-loader" style="padding: 20px;">
        <div class="skeleton" style="width: 80px; height: 14px; margin-bottom: 16px; border-radius: 4px;"></div>
        <div style="display: flex; gap: 8px; margin-bottom: 24px;">
            <div class="skeleton" style="width: 60px; height: 28px; border-radius: 12px;"></div>
            <div class="skeleton" style="width: 70px; height: 28px; border-radius: 12px;"></div>
        </div>
        <div class="skeleton" style="width: 100%; height: 60px; margin-bottom: 12px; border-radius: 12px;"></div>
        <div class="skeleton" style="width: 100%; height: 60px; border-radius: 12px;"></div>
    </div>

    <div id="widget-content" style="display: none;">
        <div style="padding: 16px; border-bottom: 1px solid #f1f5f9; background: #f8fafc;">
            <div style="font-size: 10px; font-weight: 900; color: #94a3b8; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px;">ğŸ’¼ ç•¶å‰æŒå€‰ (Live Data)</div>
            <div id="holdings-container" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
        </div>

        <div style="padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="font-size: 10px; font-weight: 900; color: #94a3b8; text-transform: uppercase;">ğŸ“¢ AI æœ€æ–°å»ºè­°</div>
            </div>
            <div id="rec-list" class="custom-scroll" style="max-height: 520px; overflow-y: auto; padding-right: 4px;"></div>
        </div>
    </div>
</div>

<style>
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    .skeleton { background-color: #e2e8f0; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    .live-dot { box-shadow: 0 0 8px #22c55e; animation: pulse 1.5s infinite; }
    .custom-scroll::-webkit-scrollbar { width: 3px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>

<script>
(function() {
    const API_URL = 'https://script.google.com/macros/s/AKfycbwmeeME_OntMnpA5bmX6pYhH_HlRArMZPiqzQP39aPPpirWt_uiKNz2MSiYMY4qdFqH/exec'; 

    function loadWidgetData() {
        fetch(API_URL + '?action=public_board')
            .then(res => res.json())
            .then(json => {
                document.getElementById('skeleton-loader').style.display = 'none';
                document.getElementById('widget-content').style.display = 'block';
                document.getElementById('widget-status').innerText = 'Gemini 2.5 Pro â€¢ è‡ªå‹•åˆ·æ–°ä¸­';

                // æŒå€‰ (å«å³æ™‚æ¼²è·Œå¹…)
                const hBox = document.getElementById('holdings-container');
                if (json.holdings && json.holdings.length > 0) {
                    hBox.innerHTML = json.holdings.map(sym => {
                        const market = json.liveMarket?.[sym] || { change: 0 };
                        const isUp = market.change >= 0;
                        const changeHtml = `<span style="color: ${isUp ? '#16a34a' : '#dc2626'}; font-size: 10px; margin-left: 4px;">${isUp?'â–²':'â–¼'}${Math.abs(market.change)}%</span>`;
                        return `
                        <a href="https://www.google.com/search?q=finance+${sym}" target="_blank" 
                           style="text-decoration: none; background: white; color: #1e293b; border: 1px solid #e2e8f0; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 800; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                           ${sym} ${changeHtml}
                        </a>`;
                    }).join('');
                }

                // å»ºè­°
                const list = document.getElementById('rec-list');
                const validData = (json.data || []).filter(i => new Date(i.date) >= new Date(Date.now() - 7 * 86400000)).sort((a,b)=>new Date(b.date)-new Date(a.date));
                
                list.innerHTML = validData.map((item, idx) => {
                    const isBuy = item.type === 'Buy';
                    return `
                    <div style="padding: 14px 8px; border-bottom: 1px solid #f1f5f9;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-weight: 900; font-size: 16px;">${item.symbol} <span style="font-size: 10px; color: #94a3b8; margin-left: 4px;">${item.date.substring(5)}</span></div>
                            <span style="background:${isBuy?'#f0fdf4':'#fef2f2'}; color:${isBuy?'#16a34a':'#dc2626'}; padding: 3px 10px; border-radius: 8px; font-size: 10px; font-weight: 900;">${isBuy?'è²·å…¥':'è³£å‡º'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                            <span style="font-size: 14px; font-weight: 800; font-family: monospace;">$${item.price.toFixed(2)}</span>
                            <span style="font-size: 9px; color: #f59e0b; background: #fffbeb; padding: 2px 8px; border-radius: 6px; font-weight: 800;">AI: ${item.count} æ¬¡</span>
                        </div>
                        ${item.analysis ? `
                        <button onclick="var el=document.getElementById('ai-${idx}'); if(el.style.display==='none'){el.style.display='block';this.innerText='æ”¶èµ·å…§å®¹ â–²';}else{el.style.display='none';this.innerText='æŸ¥çœ‹ AI è§€é» â–¼';}" style="margin-top:8px; background:none; border:none; color:#3b82f6; font-size:10px; font-weight:800; cursor:pointer; padding:0;">æŸ¥çœ‹ AI è§€é» â–¼</button>
                        <div id="ai-${idx}" style="display:none; margin-top:10px; padding:12px; background:#f8fafc; border-radius:12px; font-size:12px; color:#475569; line-height:1.6;" class="markdown-content">${marked.parse(item.analysis)}</div>
                        ` : ''}
                    </div>`;
                }).join('');
            });
    }
    
    loadWidgetData(); // åˆå§‹è¼‰å…¥
    setInterval(loadWidgetData, 300000); // æ¯ 5 åˆ†é˜éœé»˜åˆ·æ–°
})();
</script>
