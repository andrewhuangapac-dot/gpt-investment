<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾è‚¡AIæŠ•è³‡å»ºè­°</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>

    <style>
        /* CSS è®Šæ•¸èˆ‡å…¨åŸŸè¨­å®šï¼Œé¿å…æ±¡æŸ“å¤–éƒ¨ç¶²ç«™ */
        :root {
            --wg-bg: #ffffff;
            --wg-bg-alt: #f8fafc;
            --wg-border: #e2e8f0;
            --wg-text-main: #0f172a;
            --wg-text-sub: #64748b;
        }

        body {
            margin: 0;
            padding: 16px;
            background-color: #f1f5f9; /* å¤–éƒ¨é è¨­èƒŒæ™¯ */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* ğŸŸ¢ å®¹å™¨å¤§å‡ç´šï¼šå¯¬åº¦æ”¾å¯¬åˆ° 800pxï¼Œä¸¦æ”¯æ´ 100% è‡ªé©æ‡‰ */
        .ai-wg-container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            background: var(--wg-bg);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--wg-border);
            overflow: hidden;
            box-sizing: border-box;
        }

        /* æ¨™é¡Œå€ */
        .ai-wg-header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            padding: 32px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ai-wg-title { font-size: 28px; font-weight: 900; letter-spacing: 1px; margin: 0; }
        .ai-wg-subtitle { font-size: 14px; color: #94a3b8; margin-top: 6px; font-weight: 600; }

        /* å€å¡Šå…§è· */
        .ai-wg-section { padding: 24px 32px; border-bottom: 1px solid var(--wg-border); }
        .ai-wg-section-bg { background: var(--wg-bg-alt); }
        .ai-wg-section-title { font-size: 14px; font-weight: 900; color: var(--wg-text-sub); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 16px; }

        /* æŒå€‰æŒ‰éˆ•æ”¾å¤§ */
        .ai-wg-tag {
            display: inline-flex; align-items: center; gap: 8px;
            background: white; color: var(--wg-text-main);
            border: 2px solid var(--wg-border);
            padding: 10px 18px; border-radius: 16px;
            font-size: 16px; font-weight: 900;
            text-decoration: none; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: all 0.2s;
        }
        .ai-wg-tag:hover { border-color: #cbd5e1; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

        /* å»ºè­°åˆ—è¡¨èˆ‡æ–‡å­—æ”¾å¤§ */
        .ai-wg-list-item { padding: 24px 0; border-bottom: 1px dashed var(--wg-border); }
        .ai-wg-list-item:last-child { border-bottom: none; }
        
        .ai-wg-symbol { font-size: 24px; font-weight: 900; color: var(--wg-text-main); }
        .ai-wg-date { font-size: 14px; color: #94a3b8; font-weight: 700; margin-left: 12px; }
        .ai-wg-price { font-size: 22px; font-weight: 800; color: #475569; font-family: monospace; }
        
        /* æ¨™ç±¤æ”¾å¤§ */
        .ai-wg-badge { padding: 6px 16px; border-radius: 10px; font-size: 14px; font-weight: 900; letter-spacing: 1px; }
        .ai-wg-badge-buy { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
        .ai-wg-badge-sell { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .ai-wg-badge-ai { background: #fffbeb; color: #d97706; padding: 6px 16px; border-radius: 10px; font-size: 13px; font-weight: 800; }

        /* AI è§€é»å€åŸŸæ”¾å¤§ */
        .ai-wg-btn-toggle {
            background: none; border: none; padding: 12px 0; margin-top: 8px;
            color: #3b82f6; font-size: 15px; font-weight: 800; cursor: pointer;
            text-decoration: underline; display: flex; align-items: center; gap: 4px;
        }
        .ai-wg-analysis-box {
            background: var(--wg-bg-alt); padding: 24px; border-radius: 16px;
            font-size: 16px; color: #334155; line-height: 1.8;
            border: 1px solid var(--wg-border); margin-top: 8px;
        }

        /* æ»¾å‹•æ¢ç¾åŒ– (é«˜åº¦æ”¾å¯¬åˆ° 800px) */
        .ai-wg-scroll { max-height: 800px; overflow-y: auto; padding-right: 12px; margin-right: -12px; }
        .ai-wg-scroll::-webkit-scrollbar { width: 6px; }
        .ai-wg-scroll::-webkit-scrollbar-track { background: transparent; }
        .ai-wg-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* å‹•ç•« */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .skeleton { background: #e2e8f0; animation: pulse 2s infinite; border-radius: 8px; }

        /* æ‰‹æ©Ÿç‰ˆå¾®èª¿ (è¢å¹•å°æ–¼ 600px æ™‚) */
        @media (max-width: 600px) {
            .ai-wg-header { padding: 24px 20px; }
            .ai-wg-title { font-size: 22px; }
            .ai-wg-section { padding: 20px; }
            .ai-wg-symbol { font-size: 20px; }
            .ai-wg-price { font-size: 18px; }
            .ai-wg-tag { font-size: 14px; padding: 8px 14px; }
        }
    </style>
</head>
<body>

    <div class="ai-wg-container">
        <div class="ai-wg-header">
            <div>
                <h1 class="ai-wg-title">ç¾è‚¡AIæŠ•è³‡å»ºè­°</h1>
                <div class="ai-wg-subtitle" id="widget-status">è¼‰å…¥æœ€æ–°æ•¸æ“šä¸­...</div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; background: rgba(34,197,94,0.15); padding: 8px 14px; border-radius: 12px;">
                <div style="width: 10px; height: 10px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 10px #22c55e; animation: pulse 1.5s infinite;"></div>
                <span style="font-size: 13px; color: #4ade80; font-weight: 900; letter-spacing: 1px;">LIVE</span>
            </div>
        </div>

        <div id="skeleton-loader" class="ai-wg-section">
            <div class="skeleton" style="width: 120px; height: 20px; margin-bottom: 24px;"></div>
            <div style="display: flex; gap: 12px; margin-bottom: 40px;">
                <div class="skeleton" style="width: 100px; height: 44px; border-radius: 16px;"></div>
                <div class="skeleton" style="width: 120px; height: 44px; border-radius: 16px;"></div>
            </div>
            <div class="skeleton" style="width: 100%; height: 100px; margin-bottom: 20px; border-radius: 16px;"></div>
            <div class="skeleton" style="width: 100%; height: 100px; border-radius: 16px;"></div>
        </div>

        <div id="widget-content" style="display: none;">
            <div class="ai-wg-section ai-wg-section-bg">
                <div class="ai-wg-section-title">ğŸ’¼ ç•¶å‰æŒå€‰ (Live Data)</div>
                <div id="holdings-container" style="display: flex; flex-wrap: wrap; gap: 12px;"></div>
            </div>

            <div class="ai-wg-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div class="ai-wg-section-title" style="margin: 0;">ğŸ“¢ AI æœ€æ–°æ“ä½œå»ºè­°</div>
                    <div style="font-size: 12px; font-weight: 900; color: #3b82f6; background: #eff6ff; padding: 4px 10px; border-radius: 8px;">æœ€è¿‘ 7 æ—¥</div>
                </div>
                
                <div id="rec-list" class="ai-wg-scroll"></div>
            </div>
        </div>

        <div style="background: var(--wg-bg-alt); padding: 20px; text-align: center; font-size: 13px; color: #cbd5e1; font-weight: 700; border-top: 1px solid var(--wg-border);">
            Powered by Google Gemini 1.5 Pro
        </div>
    </div>

    <script>
    (function() {
        // ============================================================
        // ğŸ”´ è«‹å¡«å…¥æ‚¨çš„ Apps Script ç¶²å€
        // ============================================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbwmeeME_OntMnpA5bmX6pYhH_HlRArMZPiqzQP39aPPpirWt_uiKNz2MSiYMY4qdFqH/exec'; 
        // ============================================================

        document.title = "ç¾è‚¡AIæŠ•è³‡å»ºè­°";

        function loadWidgetData() {
            fetch(API_URL + '?action=public_board')
                .then(res => res.json())
                .then(json => {
                    document.getElementById('skeleton-loader').style.display = 'none';
                    document.getElementById('widget-content').style.display = 'block';
                    document.getElementById('widget-status').innerText = 'GPT + Gemini â€¢ æ•¸æ“šå·²åŒæ­¥';

                    // 1. æ¸²æŸ“æŒå€‰ (å­—é«”/æŒ‰éˆ•å·²æ”¾å¤§)
                    const hBox = document.getElementById('holdings-container');
                    if (json.holdings && json.holdings.length > 0) {
                        hBox.innerHTML = json.holdings.map(sym => {
                            const market = json.liveMarket?.[sym] || { change: 0 };
                            const isUp = market.change >= 0;
                            const changeHtml = `<span style="color: ${isUp ? '#16a34a' : '#dc2626'}; font-size: 13px; margin-left: 4px;">${isUp?'â–²':'â–¼'}${Math.abs(market.change).toFixed(2)}%</span>`;
                            return `
                            <a href="https://www.google.com/search?q=finance+${sym}" target="_blank" class="ai-wg-tag">
                               ${sym} ${changeHtml}
                            </a>`;
                        }).join('');
                    } else {
                        hBox.innerHTML = '<span style="font-size:15px; color:#cbd5e1; font-weight:bold;">ç›®å‰ç„¡æŒå€‰è³‡æ–™</span>';
                    }

                    // 2. æ¸²æŸ“å»ºè­°
                    const list = document.getElementById('rec-list');
                    const validData = (json.data || []).filter(i => new Date(i.date) >= new Date(Date.now() - 7 * 86400000)).sort((a,b)=>new Date(b.date)-new Date(a.date));
                    
                    if (validData.length === 0) {
                        list.innerHTML = `<div style="text-align:center; padding: 60px 20px; color:#cbd5e1; font-size:16px; font-weight:900; border:2px dashed #e2e8f0; border-radius:16px;">è¿‘ 7 æ—¥ç„¡æ–°å»ºè­°</div>`;
                        return;
                    }

                    list.innerHTML = validData.map((item, idx) => {
                        const isBuy = item.type === 'Buy';
                        const badgeClass = isBuy ? 'ai-wg-badge-buy' : 'ai-wg-badge-sell';
                        const typeText = isBuy ? 'è²·å…¥ BUY' : 'è³£å‡º SELL';
                        const formattedPrice = Number(item.price).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        
                        return `
                        <div class="ai-wg-list-item">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div>
                                    <span class="ai-wg-symbol">${item.symbol}</span>
                                    <span class="ai-wg-date">${item.date.substring(5)}</span>
                                </div>
                                <span class="ai-wg-badge ${badgeClass}">${typeText}</span>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="ai-wg-price">$${formattedPrice}</span>
                                <span class="ai-wg-badge-ai">AI åˆ†æ: ${item.count} æ¬¡</span>
                            </div>

                            ${item.analysis && item.analysis.trim() !== '' ? `
                            <div>
                                <button onclick="var el=document.getElementById('ai-${idx}'); if(el.style.display==='none'){el.style.display='block';this.innerText='æ”¶èµ·æ·±åº¦åˆ†æ â–²';}else{el.style.display='none';this.innerText='æŸ¥çœ‹ AI æ·±åº¦è§€é» â–¼';}" class="ai-wg-btn-toggle">
                                    æŸ¥çœ‹ AI æ·±åº¦è§€é» â–¼
                                </button>
                                <div id="ai-${idx}" style="display:none;" class="ai-wg-analysis-box markdown-content">
                                    ${marked.parse(item.analysis)}
                                </div>
                            </div>
                            ` : ''}
                        </div>`;
                    }).join('');
                })
                .catch(err => {
                    document.getElementById('skeleton-loader').innerHTML = `<div style="text-align:center; padding: 60px; color:#ef4444; font-size:16px; font-weight:900;">é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š</div>`;
                });
        }
        
        loadWidgetData(); 
        setInterval(loadWidgetData, 300000); // 5åˆ†é˜èƒŒæ™¯è‡ªå‹•æ›´æ–°
    })();
    </script>
</body>
</html>
