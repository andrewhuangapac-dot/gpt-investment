<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç¾è‚¡AIæŠ•è³‡å»ºè­° (é™¤éŒ¯ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; padding: 20px; background-color: #f1f5f9; font-family: -apple-system, sans-serif; }
        .app-container { max-width: 800px; margin: 0 auto; background: #fff; border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); overflow: hidden; border: 1px solid #e2e8f0; }
        .header { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); padding: 32px; color: white; }
        .section { padding: 24px 32px; border-bottom: 1px solid #f1f5f9; }
        .badge-buy { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 900;}
        .badge-sell { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 900;}
        .holding-tag { display: inline-flex; align-items: center; background: white; border: 1px solid #e2e8f0; padding: 8px 14px; border-radius: 12px; font-size: 14px; font-weight: 800; text-decoration: none; color: #0f172a;}
        @media (max-width: 600px) { body { padding: 0; } .app-container { border-radius: 0; min-height: 100vh; } .header, .section { padding: 20px; } }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="header">
            <h1 style="margin:0; font-size:24px; font-weight:900;">ç¾è‚¡AIæŠ•è³‡å»ºè­°</h1>
            <div id="widget-status" style="font-size:13px; color:#94a3b8; margin-top:6px;">ç³»çµ±é€£ç·šæ¸¬è©¦ä¸­...</div>
        </div>

        <div id="skeleton-loader" class="section">
            <h3 style="color: #3b82f6;">ğŸ”„ æ­£åœ¨å˜—è©¦æŠ“å–è³‡æ–™...</h3>
        </div>

        <div id="widget-content" style="display: none; flex-direction: column;">
            <div class="section" style="background: #f8fafc;">
                <div style="font-size: 13px; font-weight: 900; color: #64748b; margin-bottom: 16px;">ğŸ’¼ ç•¶å‰æŒå€‰</div>
                <div id="holdings-container" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
            </div>
            <div class="section">
                <div style="font-size: 13px; font-weight: 900; color: #64748b; margin-bottom: 16px;">ğŸ“¢ æœ€æ–°å»ºè­°</div>
                <div id="rec-list"></div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        // ğŸ”´ è²¼ä¸Šæ‚¨æœ€æ–°éƒ¨ç½²çš„ API ç¶²å€
        const API_URL = 'https://script.google.com/macros/s/AKfycbxVWYAtSZxNUSiN33UwSbMRd7HWRSGhcuAVjCaAH-jNNqO2LYVAeL_pbYP4-NqG9VrN/exec'; 

        function showError(msg, details = "") {
            document.getElementById('skeleton-loader').innerHTML = `
                <div style="background:#fef2f2; border:1px solid #fecaca; padding:20px; border-radius:12px;">
                    <h3 style="color:#dc2626; margin-top:0;">ğŸš¨ ${msg}</h3>
                    <code style="color:#7f1d1d; font-size:12px; word-break:break-all;">${details}</code>
                </div>
            `;
        }

        function loadWidgetData() {
            fetch(API_URL + '?action=public_board')
                .then(async res => {
                    // 1. æ””æˆª HTTP ç‹€æ…‹éŒ¯èª¤
                    if (!res.ok) throw new Error(`HTTP ç‹€æ…‹ç¢¼: ${res.status}`);
                    
                    // 2. æª¢æŸ¥å›å‚³çš„æ˜¯å¦çœŸçš„æ˜¯ JSON
                    const text = await res.text();
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        throw new Error(`å›å‚³çš„ä¸æ˜¯ JSONï¼Œå¯èƒ½æ˜¯æ¬Šé™éŒ¯èª¤ã€‚æ”¶åˆ°å…§å®¹å‰ 100 å­—å…ƒ: ${text.substring(0, 100)}`);
                    }
                })
                .then(json => {
                    // 3. æª¢æŸ¥å¾Œç«¯è‡ªå®šç¾©éŒ¯èª¤
                    if (json.status === 'error') throw new Error(`å¾Œç«¯å›å‚³éŒ¯èª¤: ${json.message}`);

                    document.getElementById('skeleton-loader').style.display = 'none';
                    document.getElementById('widget-content').style.display = 'flex';
                    document.getElementById('widget-status').innerText = 'âœ“ é€£ç·šæˆåŠŸ';

                    const hBox = document.getElementById('holdings-container');
                    if (json.holdings && json.holdings.length > 0) {
                        hBox.innerHTML = json.holdings.map(sym => {
                            const market = json.liveMarket?.[sym] || { change: 0 };
                            return `<a href="https://www.google.com/finance/quote/${sym}:NASDAQ" target="_blank" class="holding-tag">${sym} <span style="color:${market.change>=0?'#16a34a':'#dc2626'}; font-size:11px; margin-left:4px;">${market.change>=0?'â–²':'â–¼'}${Math.abs(market.change).toFixed(2)}%</span></a>`;
                        }).join('');
                    } else {
                        hBox.innerHTML = '<span style="color:#cbd5e1; font-size:14px; font-weight:bold;">ç„¡æŒå€‰è³‡æ–™</span>';
                    }

                    const list = document.getElementById('rec-list');
                    const validData = (json.data || []).sort((a,b)=>new Date(b.date)-new Date(a.date));
                    
                    if (validData.length === 0) {
                        list.innerHTML = `<div style="text-align:center; padding:40px; color:#cbd5e1; font-weight:bold;">ç„¡å»ºè­°ç´€éŒ„</div>`;
                        return;
                    }

                    list.innerHTML = validData.map((item, idx) => {
                        const isBuy = item.type === 'Buy';
                        return `
                        <div style="padding: 20px 0; border-bottom: 1px dashed #e2e8f0;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <div><strong style="font-size:20px;">${item.symbol}</strong> <span style="font-size:12px; color:#94a3b8; margin-left:8px;">${item.date.substring(5)}</span></div>
                                <span class="${isBuy?'badge-buy':'badge-sell'}">${isBuy?'è²·å…¥':'è³£å‡º'}</span>
                            </div>
                            <div style="font-size:18px; font-weight:800; color:#475569;">$${item.price}</div>
                        </div>`;
                    }).join('');
                })
                .catch(err => {
                    // å°‡çœŸå¯¦çš„éŒ¯èª¤åŸå› å°åœ¨ç•«é¢ä¸Š
                    showError("é€£ç·šå¤±æ•—ï¼æŠ“åˆ°éŒ¯èª¤åŸå› ï¼š", err.message || err.toString());
                });
        }
        
        loadWidgetData(); 
    })();
    </script>
</body>
</html>
