<div id="ai-portfolio-widget" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft JhengHei', sans-serif; border: 1px solid #e2e8f0; border-radius: 24px; overflow: hidden; max-width: 380px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); background: white; margin: 0 auto;">
    
    <div style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <div id="widget-title-text" style="font-weight: 900; font-size: 18px; letter-spacing: 0.5px;">ç¾è‚¡ AI æŠ•è³‡å»ºè­°</div>
            <div style="font-size: 11px; color: #94a3b8; margin-top:2px; font-weight: 500;">GPT + Gemini</div>
        </div>
        <div style="display: flex; align-items: center; gap: 6px; background: rgba(34, 197, 94, 0.1); padding: 4px 8px; border-radius: 8px;">
            <div style="width: 6px; height: 6px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 8px #22c55e;"></div>
            <span style="font-size: 10px; color: #4ade80; font-weight: 900;">LIVE</span>
        </div>
    </div>

    <div style="padding: 16px; border-bottom: 1px solid #f1f5f9; background: #f8fafc;">
        <div style="font-size: 10px; font-weight: 900; color: #94a3b8; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px;">
            ğŸ’¼ æŒæœ‰æ¨™çš„ Holdings
        </div>
        <div id="holdings-container" style="display: flex; flex-wrap: wrap; gap: 8px;">
            <span style="font-size: 12px; color: #cbd5e1; italic">åŒæ­¥ä¸­...</span>
        </div>
    </div>

    <div style="padding: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 0 4px;">
            <div style="font-size: 10px; font-weight: 900; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px;">ğŸ“¢ æœ€æ–°æ“ä½œå»ºè­°</div>
            <div style="font-size: 9px; font-weight: bold; color: #3b82f6; background: #eff6ff; padding: 2px 6px; border-radius: 4px;">NEWEST</div>
        </div>
        
        <div id="rec-list" class="custom-scroll" style="max-height: 520px; overflow-y: auto; padding-right: 4px;">
            </div>
    </div>

    <div style="background: #f8fafc; padding: 12px; text-align: center; font-size: 10px; color: #cbd5e1; border-top: 1px solid #f1f5f9; font-weight: 500;">
        Powered by Google Gemini AI Terminal
    </div>
</div>

<style>
    /* ç¾åŒ–æ»¾å‹•æ¢ */
    .custom-scroll::-webkit-scrollbar { width: 3px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    .btn-active:active { transform: scale(0.96); opacity: 0.8; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>

<script>
(function() {
    // ============================================================
    // ğŸ”´ è²¼å…¥æ‚¨çš„ API ç¶²å€
    // ============================================================
    const API_URL = 'https://script.google.com/macros/s/AKfycbyXBfSISMPrZtiSt24Wsao-9V7bN5SZ_FjENs48tRiOixqzgxrac0tMa1n9F-Ril6ad/exec'; 
    const DAYS_LIMIT = 7; // å±•ç¤ºæœ€è¿‘ 7 å¤©çš„å»ºè­°
    // ============================================================

    fetch(API_URL + '?action=public_board')
        .then(res => res.json())
        .then(json => {
            // 1. æŒå€‰æ¸²æŸ“ (iOS æŒ‰éˆ•é¢¨æ ¼)
            const holdingsBox = document.getElementById('holdings-container');
            if (json.holdings && json.holdings.length > 0) {
                holdingsBox.innerHTML = json.holdings.map(sym => `
                    <a href="https://www.google.com/search?q=finance+${sym}" target="_blank" 
                       style="text-decoration: none; background: white; color: #1e293b; border: 1px solid #e2e8f0; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 800; display: inline-block; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;"
                       class="btn-active">
                       ${sym} <span style="font-size: 9px; opacity: 0.3;">â†—</span>
                    </a>`).join('');
            } else {
                holdingsBox.innerHTML = '<span style="font-size:11px; color:#cbd5e1;">ç›®å‰ç„¡æŒå€‰æ¨™çš„</span>';
            }

            // 2. å»ºè­°åˆ—è¡¨æ¸²æŸ“
            const list = document.getElementById('rec-list');
            if (!json.data || json.data.length === 0) { renderEmpty(list, "æš«ç„¡å…¬é–‹å»ºè­°"); return; }

            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - DAYS_LIMIT);
            cutoffDate.setHours(0, 0, 0, 0);

            // éæ¿¾ä¸¦æ’åº
            const validData = json.data
                .filter(item => new Date(item.date) >= cutoffDate)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (validData.length === 0) { renderEmpty(list, `è¿‘ ${DAYS_LIMIT} æ—¥ç„¡æ–°å»ºè­°`); return; }
            
            let html = '';
            validData.forEach((item, index) => {
                const isBuy = item.type === 'Buy';
                const color = isBuy ? '#16a34a' : '#dc2626';
                const bg = isBuy ? '#f0fdf4' : '#fef2f2';
                const dateShort = item.date.substring(5);
                const formattedPrice = item.price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const hasAnalysis = item.analysis && item.analysis.trim() !== '';
                const uniqueId = `pub-analysis-${index}`;

                html += `
                <div style="padding: 14px 8px; border-bottom: 1px solid #f1f5f9; display: flex; flex-direction: column; gap: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: 900; color: #0f172a; font-size: 16px;">${item.symbol}</span>
                            <span style="font-size: 10px; color: #94a3b8; font-weight: 700; font-family: monospace;">${dateShort}</span>
                        </div>
                        <span style="background:${bg}; color:${color}; padding: 3px 10px; border-radius: 8px; font-size: 10px; font-weight: 900; text-transform: uppercase; border: 1px solid ${isBuy ? '#dcfce7' : '#fee2e2'};">
                            ${isBuy ? 'è²·å…¥ Buy' : 'è³£å‡º Sell'}
                        </span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2px;">
                        <span style="font-size: 14px; font-weight: 800; color: #475569; font-family: monospace;">$${formattedPrice}</span>
                        <div style="font-size: 9px; color: #f59e0b; font-weight: 800; background: #fffbeb; padding: 2px 8px; border-radius: 6px;">
                            AI åˆ†æ: ${item.count} æ¬¡
                        </div>
                    </div>

                    ${hasAnalysis ? `
                    <div style="margin-top: 6px;">
                        <button onclick="togglePubDetails('${uniqueId}', this)" style="background:none; border:none; color:#3b82f6; font-size:10px; font-weight:800; cursor:pointer; text-decoration:underline; padding:0; display:flex; align-items:center; gap:2px;">
                            æŸ¥çœ‹ AI è§€é»è§£è®€ â–¼
                        </button>
                        <div id="${uniqueId}" style="display: none; margin-top: 10px; padding: 12px; background: #f8fafc; border-radius: 12px; font-size: 12px; color: #475569; line-height: 1.6; border: 1px solid #e2e8f0; text-align: justify;" class="markdown-content">
                            ${marked.parse(item.analysis)}
                        </div>
                    </div>` : ''}
                </div>`;
            });
            list.innerHTML = html;
        })
        .catch(err => {
            renderEmpty(document.getElementById('rec-list'), "ç¶²è·¯åŒæ­¥å¤±æ•—");
        });

    function renderEmpty(element, message) {
        element.innerHTML = `<div style="text-align:center; color:#cbd5e1; font-size:12px; padding:40px; font-weight: 800; border: 2px dashed #f1f5f9; border-radius: 20px;">${message}</div>`;
    }
})();

// å…¨åŸŸåˆ‡æ›å‡½å¼
function togglePubDetails(id, btn) {
    const el = document.getElementById(id);
    if(el.style.display === 'none') {
        el.style.display = 'block';
        btn.innerHTML = 'æ”¶èµ·å…§å®¹ â–²';
    } else {
        el.style.display = 'none';
        btn.innerHTML = 'æŸ¥çœ‹ AI è§€é»è§£è®€ â–¼';
    }
}
</script>
